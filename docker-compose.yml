services:
    database:
        image: mongo:7.0
        container_name: database
        restart: unless-stopped
        ports:
            - '27017:27017'
        volumes:
            - database_data:/data/db
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: password
            MONGO_INITDB_DATABASE: sales_analytics
        healthcheck:
            test:
                [
                    'CMD',
                    'mongosh',
                    '-u',
                    'root',
                    '-p',
                    'password',
                    '--authenticationDatabase',
                    'admin',
                    '--eval',
                    "db.adminCommand('ping')",
                ]
            interval: 10s
            timeout: 10s
            retries: 5
            start_period: 10s

    database-admin:
        image: mongo-express
        container_name: database-admin
        restart: unless-stopped
        environment:
            ME_CONFIG_MONGODB_URL: mongodb://root:password@database:27017/
            ME_CONFIG_MONGODB_ADMINUSERNAME: root
            ME_CONFIG_MONGODB_ADMINPASSWORD: password
            ME_CONFIG_MONGODB_SERVER: database
            ME_CONFIG_MONGODB_PORT: 27017
            ME_CONFIG_MONGODB_ENABLE_ADMIN: 'true'
            ME_CONFIG_BASICAUTH_USERNAME: admin
            ME_CONFIG_BASICAUTH_PASSWORD: admin
        ports:
            - '8081:8081'
        depends_on:
            database:
                condition: service_healthy

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: backend
        restart: unless-stopped
        ports:
            - '8001:8001'
        environment:
            - PYTHONUNBUFFERED=1
        env_file:
            - ./backend/.env
        volumes:
            - ./backend:/app
        depends_on:
            database:
                condition: service_healthy
        healthcheck:
            test:
                [
                    'CMD',
                    'python',
                    '-c',
                    "import urllib.request; urllib.request.urlopen('http://localhost:8001/api/')",
                ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        container_name: frontend
        restart: unless-stopped
        ports:
            - '3000:3000'
        env_file:
            - ./frontend/.env
        volumes:
            - ./frontend:/app
            - /app/node_modules
        depends_on:
            - backend

volumes:
    database_data:
